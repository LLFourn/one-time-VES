%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
\section{Introduction}

In 2017, Andrew Poelstra posted a message to the Mimblewimble mailing list\cite{poelstra-bitcoin-dev-scriptless} demonstrating an interesting feature of the Schnorr signature scheme. He showed that through a small tweak to the signing algorithm the core lock construction of the lightning payment channel network\cite{poon2016bitcoin} could be realised without using Bitcoin's \emph{smart contract} language called \emph{script}. This was a remarkable discovery as the existing proposal relied heavily on enforcing the lock logic using script based hash locks. His explanation ended with ``I'm very excited about this'' and in retrospect his excitement seems justified. This breakthrough has been used to create ``scriptless'' variants of most Bitcoin layer-2\footnote{In this work we will use layer-2 to refer to any protocol that requires a direct communication channel between participants not just "off-chain" payment channel type protocols} protocols (we give a fairly comprehensive list in Section~\ref{exisitng-protocols}).

\textbf{Scriptless scripts.} Achieving smart contract logic without script has been termed \emph{scriptless scripts} within the Bitcoin research community. It is a significant challenge to the usual conception of smart contracts. Instead of being expressed in a programming language, a smart contract becomes a kind of multi-party computation that outputs transaction signatures according to the desired contract logic. In other words, if according to a contract Alice is meant to receive funds when event X occurs, instead of expressing event X in some way using the smart contract language, the contract is set up such that Alice is only able to compute a signature on a transaction that claims the funds due to her when event X occurs. This is clearly beneficial to Alice because no passive observer of the blockchain can tell that the transaction depended on event X, rather it (optimistically) looks just like a normal payment transaction.

\textbf{Verifiably Encrypted Signatures.} In this work we frame the adaptor signature, the key building block of scriptless protocols, as a kind of signature encryption. In particular, we find it almost fits the definition of \emph{verifiably encrypted signatures}\cite{Boneh:2003:AVE:1766171.1766207} (VES) introduced for the BLS signature scheme\cite{Boneh:2001:SSW:647097.717005}. A VES scheme enables a signer to produce an encrypted signature whose validity can be verified non-interactively. The adaptor signature is a VES where the encryption is \emph{one-time} in a similar sense to a one-time pad: the decryption key can easily be recovered from the ciphertext and its plaintext (the signature).

\textbf{Fair Exchange of Signatures Without a Trusted Party}. This ``one-time'' property may seem like a bug, but in many settings it is actually a powerful feature. Consider the motivating example for the original VES scheme\cite{Boneh:2003:AVE:1766171.1766207}: two parties, Alice and Bob, wish to fairly exchange signatures with the assistance of a trusted third party named the \emph{adjudicator}. First, Alice sends to Bob her signature encrypted under the adjudicator's public key. Bob verifies the validity of the signature encryption and then sends his signature to Alice. If Alice refuses to reciprocate, Bob may ask the adjudicator to intervene by decrypting the encryption of Alice's signature he already has. If we assume the adjudicator is able to correctly assess the situation (i.e.\ will not be tricked by a malicious Bob) then this a secure optimistic fair signature exchange protocol.

With a one-time VES we can achieve the fair exchange of signatures \emph{without} a trusted party under the assumption that the signatures need to be published publicly to be useful. The one-time property gives the Bitcoin layer-2 protocol designer leverage over malicious parties by forcing them to leak a secret key when they publish a decrypted signature. This leaked key can then be used by honest parties to carry on the protocol and claim the funds due to them. A simple one-time VES fair signature exchange protocol can be described as follows: Alice generates her signature encryption under a public encryption key she herself generates and sends the key and the ciphertext to Bob. Bob responds by generating a signature encrypted under the same key. Alice decrypts this signature and publishes it. Due to the one-time property of the VES, Bob is able to recover the Alice's decryption key and decrypt the signature from the ciphertext given to him by Alice.

% Perhaps note that this fair exchange is possible by using script

\subsection{Survey of Scriptless Protocols}
\label{exisitng-protocols}

In order to motivate our formalisation, we first review how one-time VES schemes (i.e.\ adaptor signatures) are used in existing scriptless layer-2 protocol proposals. We give a simplified explanation of each protocol below focusing on the role the VES plays in the construction. Interestingly not every proposal requires the VES to have the one-time property; the ``Discreet Log Contracts'' and lottery protocols only need an ordinary VES\@. In practice, each protocol requires a VES scheme with a two-party encrypted signing algorithm but we leave this out to simplify the description (Section~\ref{semi-scriptless} focuses on this point). In general, each scriptless protocol is more efficient in terms of transaction footprint and more confidential than its script based counterpart.

\hfill \break \textbf{Atomic swaps.}  In an atomic swap, two parties, Alice and Bob, exchange the ownership of two assets, $A$ and $B$, on two different ledgers, $\alpha$ and $\beta$. As initially conceived\cite{atomic-swap}, Alice generates a random secret $y$ and shares the hash of it $Y \gets H(y)$ with Bob. Alice then locks $A$ in a smart contract on $\alpha$ that will only release $A$ if Bob activates it with $y'$ such that $Y = H(y')$. Bob locks $B$ into a similar contract on $\beta$. Alice then claims $B$ by activating the contract on $\beta$ with $y$. Bob then learns $y$ and claims $A$ with it on $\alpha$.

The scriptless atomic swap protocol\cite{scriptless-atomic-swap} is the classic example of how to apply adaptor signatures to create a practically identical structure without requiring smart contract based hash operations. Rather than a hash pre-image, Alice generates an encryption key-pair $(y,Y)$. On $\alpha$ Alice gives Bob a one-time VES under $Y$ on a transaction giving Bob $A$ should he be able to decrypt it. Bob then sends Alice a one-time VES under $Y$ on a transaction giving Alice $B$. Alice decrypts he signature with $y$ and broadcasts to claim $B$. Bob then sees the decrypted signature and due to the one-time property of the VES he is able to extract $y$ from it and decrypts his own signature to claim $A$. Note that, unlike the hash based protocol, the secret $y$ is never placed into any transaction on either ledger making it much harder to link the transactions on $\alpha$ and $\beta$ with each other.

\hfill \break \textbf{Payment channels.} Poelstra's original mailing list post applies the same transformation used in the scriptless atomic swap to the Lightning Network\cite{poon2016bitcoin}. Payment channels gain an additional benefit from having a group element (the encryption key) as the lock, rather than a hash. Using the homomorphic properties of the group, the lock can be randomised at each hop making it difficult to link a payments traveling through the network just based on them having the same lock. This was formalised in \cite{cryptoeprint:2018:472}. %TODO Boomarang
Informal discussions on the lightning network development mailing list also suggest other benefits of using group elements, rather than hashes as the lock\cite{lightning-dev-scriptless-scripts}.

\hfill \break \textbf{Discreet Log Contracts.} In layer-2 protocols, ``oracles'' are parties who are trusted to cryptographically attest to the outcome of real world events. In his work ``Discreet Log Contracts''\cite{dryja2017discreet} Dryja proposes a model where rather than interacting with smart contracts directly, oracles publicly reveal secret information (usually a signature) depending on the outcome of the real world event. Two parties who wish to engage in a bet can construct a set of jointly signed transactions where only one of them becomes valid determined by the signature the oracle reveals. Importantly, the oracle remains oblivious to the existence of the bet.

The protocol in the original work required three on-chain transactions to settle a bet. We observe that by using a one-time VES we can construct a more efficient two transaction protocol. %TODO cite ruben
The oracle announces it will reveal the decryption key corresponding to public encryption key $A$ or $B$ depending on the outcome of some event. Alice and Bob wish to bet 1 BTC on outcomes $A$ and $B$ respectively with even odds. To securely set up this contract, they both pay their 1 BTC into a single joint 2 BTC output and Alice gives a VES on a transaction paying Bob the 2 BTC encrypted by $B$ and Bob gives a VES on a transaction paying Alice the 2 BTC encrypted by $A$. When the oracle releases the decryption key for one of $A$ or $B$, the winner can decrypt their transaction signature and claim the 2 BTC with 1 BTC profit. Note that this protocol does not require the VES to be one-time.

\hfill \break \textbf{Tumblers.}  Inspired by Chaumian eCash\cite{chaum1983blind}, the first tumbler protocol, TumbleBit\cite{tumblebit} enabled Bitcoin payments through an untrusted intermediary called the \emph{tumbler} to be mixed so it is hard (even for the tumbler) to link the incoming and outgoing payments. TumbleBit requires script in the un-cooperative case to verify that the tumbler correctly releases blinded RSA decryptions.

Tairi et al.\ recently proposed a more efficient scriptless tumbler called A$^2$L\cite{cryptoeprint:2019:589}. The tumbler first locks coins up and gives a VES on a transaction releasing the coins to the \emph{receiver} encrypted under $A = g^{\alpha_i}$. The tumbler also gives the sender a homomorphic encryption of the decryption key $\alpha_i$. The \emph{sender} then attempts to pay the tumbler for $\alpha_i$ without letting the tumbler know which $\alpha$ she paid for (the tumbler is presumed to be executing many such protocols at once each with a different $\alpha$). The sender purchases $\alpha_i$ by giving the tumbler a one-time VES on a payment transaction encrypted under a blinded version of the encryption key e.g. $g^{\alpha_i + \beta}$ where the sender knows $\beta$. When the tumbler takes the payment $\alpha_i + \beta$ is revealed to the sender allowing them to decrypt receiver's signature.

In addition, a scriptless tumbler protocol based on blind Schnorr signatures is proposed in \cite{blind-tumbler}.

\hfill \break  \textbf{Lotteries.} The possibility of Bitcoin lotteries without a trusted party\cite{bitcoin_talk} was one of the first ideas academic Bitcoin researchers formally explored\cite{bentov_how_to_use_bitcoin}\cite{andrychowicz_lottery}. In its simplest form two parties both bet 1 Bitcoin and at the end of the protocol, the randomly chosen winner has 2 Bitcoin and the loser has 0. Most proposals, including more recent ones\cite{bartoletti_lottery}\cite{DBLP:journals/corr/MillerB16} are based on hash commitment coin tossing to produce the random outcome. The protocols use script to check the commitment openings on-chain.

A scriptless lottery was recently proposed\cite{fournier_lottery} which uses the \emph{oblivious signatures} from \cite{1-of-n-oblivious-signatures} rather than hash commitment coin tossing. The oblivious signature scheme is essentially built on a VES: The receiver first sends a Pedersen commitment $T = g^xh^c$ where $c \in \bin$, to the signer. The singer then sends a VES for each of $m_0$ and $m_1$ encrypted under $T$ and $Th^{-1}$ respectively. Due to the binding property of the commitment, the receiver only knows the decryption key $x$ for the signature on $m_c$ but the sender never learns $c$. The proposed protocol uses the adaptor signature style one-time VES but in principle the idea works with any VES as long as there is an algorithm that allows the receiver to verifiably produce a set of public keys for which it only knows one of the private keys (without anyone else knowing which one).

\hfill \break  \textbf{Pay for commitment opening.} A script based smart contract to pay for an opening hash commitment is straightforward to construct. A scriptless alternative for paying for the opening of a Pedersen commitment has been proposed in \cite{pay-for-pedersen}.

\subsection{Our Contribution}

In Section~\ref{VES-section}, we contribute to theory of verifiably encrypted signatures in general. The original security definitions\cite{Boneh:2003:AVE:1766171.1766207} only required the scheme to be secure if the encryption key-pair was chosen by the trusted adjudicator. VES schemes secure by these definitions are generally inappropriate for use in layer-2 protocols where a trusted party is rarely assumed. We propose new security definitions without reference to trusted parties and show that all existing schemes satisfy our new definitions.

In Section~\ref{otVES} we formally introduce one-time verifiably encrypted signatures. We then frame the existing Schnorr and ECDSA ``adaptor signature'' schemes as one-time VES schemes. We prove the Schnorr scheme secure but find that the ECDSA one-time VES unintentionally leaks a Diffie-Hellman tuple for the signing key and the encryption key. We incorporate this weakness and prove that this is at least the only problem with the scheme.

Finally in Section~\ref{semi-scriptless} we introduce the practical ``semi-scriptless'' paradigm where protocols can only have scripts with a single \texttt{OP\_CHECKMULTISIG} script opcode. We show how to generically transform any scriptless protocol into a semi-scriptless protocol using the ECDSA one-time VES\@. This allows any scriptless protocol to be practically realised on Bitcoin as it is today without a complex two-party ECDSA multi-signature scheme.

\subsection{Previous Work with Adaptor Signatures In Security Proofs}

As far as we are aware, this work is the first attempt to formalise the adaptor signature as a primitive on its own. However, the works of \cite{cryptoeprint:2018:472} and \cite{cryptoeprint:2019:589} use the idea of the adaptor signature and formally argue their security in the \emph{Universal Composability} (UC) model\cite{UC}. Their UC simulation ensures that corrupted parties may learn nothing but the signature itself from any adaptor signatures they receive. In general, the UC simulation is achieved through efficient \emph{non-interactive zero knowledge proofs of knowledge} for discrete logarithms. This allows the simulator in the ideal world to extract the secret keys of the corrupted party and use them to synthetically create adaptor signatures to simulate the view of the adversary in the real world.

In our work, we use a weaker game-based model of security. This ensure that the corrupted party learns nothing \emph{useful}, rather than nothing at all, from a signature encryption other than the signature itself. In particular, we will define security for VES and one-time VES schemes such that an adversary cannot learn anything from a signature encryption that will help them forge a signature on another message. We believe this is a viable approach in general, but it is especially reasonable in the context of Bitcoin style ledgers. In layer-2 Bitcoin protocols, the keys that own coins are not re-used between protocol executions so it is easy to ensure that a key is only used in the particular ways our game-based definitions can ensure is secure.

\subsection{Future Work}

\textbf{Multi-party VES.} All proposed scriptless protocols require signature encryptions generated through a two-party encrypted signing protocol. The security of Schnorr two-party one-time VES protocols deserves attention since it is being put forward as the main primitive for the protocols listed in Section~\ref{exisitng-protocols} above in the long-term. We limit ourselves to focusing on defining formal security for single singer VES schemes and leave this analysis for future work.

\hfill \break \textbf{Schnorr vs BLS.} This work suggests a significant trade-off between the choice of Schnorr and BLS as the main signature scheme for Bitcoin-like systems. BLS admits an efficient VES scheme\cite{Boneh:2003:AVE:1766171.1766207} and extremely attractive non-interactive signature aggregation \cite{compact-blockchains-bls}. On the other hand, Schnorr admits a less elegant interactive multi-signature scheme\cite{musig} but a very efficient one-time VES scheme. Additionally, it should be possible to create a Schnorr (not one-time) VES scheme with general zero-knowledge proof techniques where as a one-time VES for BLS looks much less likely. This trade off deserves further exploration including  the possibility of a signature scheme that admits both an efficient VES and one-time VES scheme.
